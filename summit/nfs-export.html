<head>
    <title>NFS Export</title>
    <meta charset="utf-8">
    <link href="../base1/cockpit.css" type="text/css" rel="stylesheet">
    <script src="../base1/jquery.js"></script>
    <script src="../base1/cockpit.js"></script>
</head>
<body>
    <div class="container-fluid" style='max-width: 400px'>
        <table class="form-table-ct">
            <tr>
                <td><label class="control-label" for="path">Path</label></td>
                <td><input class="form-control" id="path" value=""></td>
            </tr>
            <tr>
                <td><label class="control-label" for="domain">Domain</label></td>
                <td><input class="form-control" id="domain" value="*"></td>
            </tr>
            <tr>
                <td><label class="control-label" for="options">Options</label></td>
                <td><input class="form-control" id="options" value="rw,sync"></td>
            </tr>
            <tr>
                <td><button class="btn btn-default btn-primary" id="export">Export</button></td>
		<td><span id="result"></span></td>
            </tr>
        </table>
        <p>
	    <pre id="output"></pre>
        </p>
    </div>

    <script>
        var path = $("#path");
        var domain = $("#domain");
        var options = $("#options");
        var result = $("#result");
        var output = $("#output");
        output.toggle(false);

        $("#export").on("click", run);

        function run() {
            result.empty();
            output.empty();

            file = cockpit.file("/etc/exports", {
                "superuser": "try"
            }).modify(function(old) {
                return path.val() + " " + domain.val() + "(" + options.val() + ")";
            }).then(function () {
                var proc = cockpit.spawn(["exportfs", "-a"], {
                    "err": "out",
                    "superuser": "try"
                });
                proc.stream(stream);
                proc.fail(fail);
                proc.done(success);
            }).fail(fail);
        }

        function stream(data) {
            output.toggle(true);
            output.append(document.createTextNode(data));
        }

        function success() {
            result.css("color", "green");
            result.text("success");
        }

        function fail(ex) {
            result.css("color", "red");
            result.text("failed to update exports");
        }
    </script>
</body>
</html>
